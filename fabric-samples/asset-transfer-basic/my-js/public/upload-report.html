<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Quality Report - RiceTrace</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Upload Quality Report</h1>
        
        <div class="form-container">
            <form id="uploadForm">
                <div class="form-group">
                    <label for="userRole">Current Role</label>
                    <input type="text" id="userRole" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label for="reportFile">Select Quality Report File</label>
                    <input type="file" id="reportFile" accept=".pdf,.jpg,.jpeg,.png" required>
                    <small>Supported formats: PDF, JPG, PNG, max 5MB</small>
                </div>

                <button type="submit">Upload Report</button>
            </form>

            <div id="uploadResult"></div>
        </div>

        <div class="section">
            <h2>My Reports List</h2>
            <button onclick="loadMyReports()">Refresh List</button>
            <div id="reportsList"></div>
        </div>

        <div class="navigation">
            <a href="index.html">Back to Home</a>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Initialize page with current role
        document.addEventListener('DOMContentLoaded', function() {
            initRoleSwitcher();
            const currentRole = getCurrentRole();
            document.getElementById('userRole').value = ROLE_NAMES[currentRole] || currentRole;
        });

        // Upload form handler
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('reportFile');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                showError('uploadResult', 'Please select a file to upload');
                return;
            }

            const file = fileInput.files[0];
            const role = getCurrentRole(); // Use current role from localStorage

            // Validate file size
            if (file.size > 5 * 1024 * 1024) {
                showError('uploadResult', 'File size cannot exceed 5MB');
                return;
            }

            showLoading('uploadResult', 'Uploading report...');

            try {
                const formData = new FormData();
                formData.append('report', file);

                const response = await fetch(`${baseURL}/reports/upload`, {
                    method: 'POST',
                    headers: {
                        'X-User-Role': role
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>âœ… Report uploaded successfully</h3>
                            <p><strong>Report ID:</strong> ${result.data.reportId}</p>
                            <p><strong>File Hash:</strong> ${result.data.fileHash.substring(0, 16)}...</p>
                            <p><strong>Status:</strong> ${result.data.status}</p>
                            <p><strong>Note:</strong> Report needs to be approved before use</p>
                        </div>
                    `;
                    
                    // Clear form
                    document.getElementById('reportFile').value = '';
                    
                    // Refresh report list
                    setTimeout(() => loadMyReports(), 1000);
                } else {
                    showError('uploadResult', result.message || 'Upload failed');
                }
            } catch (error) {
                showError('uploadResult', `Upload failed: ${error.message}`);
            }
        });

        // Load my reports list
        async function loadMyReports() {
            const role = getCurrentRole();
            const listDiv = document.getElementById('reportsList');
            
            showLoading('reportsList', 'Loading reports list...');

            try {
                const response = await fetch(`${baseURL}/reports/my`, {
                    headers: {
                        'X-User-Role': role
                    }
                });

                const result = await response.json();

                if (result.success) {
                    if (result.data.length === 0) {
                        listDiv.innerHTML = '<p>No reports found</p>';
                        return;
                    }

                    let html = '<table><thead><tr><th>File Name</th><th>Status</th><th>Upload Time</th><th>Report ID</th></tr></thead><tbody>';
                    
                    result.data.forEach(report => {
                        const statusClass = report.status === 'APPROVED' ? 'approved' : 
                                          report.status === 'REJECTED' ? 'rejected' : 'pending';
                        const createTime = new Date(report.created_at).toLocaleString('en-US');
                        
                        html += `
                            <tr>
                                <td>${report.file_name}</td>
                                <td><span class="status ${statusClass}">${report.status}</span></td>
                                <td>${createTime}</td>
                                <td style="font-family: monospace; font-size: 12px;">${report.id}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    listDiv.innerHTML = html;
                } else {
                    showError('reportsList', result.message || 'Loading failed');
                }
            } catch (error) {
                showError('reportsList', `Loading failed: ${error.message}`);
            }
        }

        // Load reports list when page loads
        window.addEventListener('load', () => {
            loadMyReports();
        });
    </script>
</body>
</html> 