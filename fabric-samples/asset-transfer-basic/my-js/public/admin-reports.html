<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Review Management - RiceTrace</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Report Review Management</h1>
        <p><strong>Note:</strong> This is a development test page</p>
        
        <div class="section">
            <h2>Pending Reports List</h2>
            <button onclick="loadPendingReports()">Refresh List</button>
            <div id="pendingReports"></div>
        </div>

        <div class="navigation">
            <a href="index.html">Back to Home</a>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Initialize page with role switcher
        document.addEventListener('DOMContentLoaded', function() {
            initRoleSwitcher();
        });

        // Load pending reports only
        async function loadPendingReports() {
            const listDiv = document.getElementById('pendingReports');
            showLoading('pendingReports', 'Loading pending reports...');

            try {
                // Get reports from all roles
                const roles = ['farmer', 'processor', 'consumer'];
                let allReports = [];

                for (const role of roles) {
                    try {
                        const response = await fetch(`${baseURL}/reports/my`, {
                            headers: { 'X-User-Role': role }
                        });
                        const result = await response.json();
                        if (result.success) {
                            allReports = allReports.concat(result.data.map(report => ({...report, role})));
                        }
                    } catch (error) {
                        console.warn(`Failed to get ${role} reports:`, error.message);
                    }
                }

                // Filter only PENDING reports (exclude REJECTED)
                const pendingReports = allReports.filter(report => 
                    report.status === 'PENDING'
                );

                if (pendingReports.length === 0) {
                    listDiv.innerHTML = '<p>No pending reports found</p>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Report ID</th>
                                <th>File Name</th>
                                <th>Uploader</th>
                                <th>Status</th>
                                <th>Upload Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                pendingReports.forEach(report => {
                    const createTime = new Date(report.created_at).toLocaleString('en-US');
                    
                    html += `
                        <tr>
                            <td style="font-family: monospace; font-size: 11px;">${report.id}</td>
                            <td>${report.file_name}</td>
                            <td>${report.uploaded_by}</td>
                            <td><span class="status pending">${report.status}</span></td>
                            <td>${createTime}</td>
                            <td>
                                <button onclick="updateReportStatus('${report.id}', 'APPROVED')" 
                                        style="background: #4caf50; color: white; border: none; padding: 4px 8px; margin: 2px;">
                                    Approve
                                </button>
                                <button onclick="updateReportStatus('${report.id}', 'REJECTED')" 
                                        style="background: #f44336; color: white; border: none; padding: 4px 8px; margin: 2px;">
                                    Reject
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                listDiv.innerHTML = html;

            } catch (error) {
                showError('pendingReports', `Loading failed: ${error.message}`);
            }
        }

        // Update report status
        async function updateReportStatus(reportId, newStatus) {
            try {
                showLoading('pendingReports', `${newStatus === 'APPROVED' ? 'Approving' : 'Rejecting'} report...`);

                // Use database operation (simplified version)
                // Production environment should use dedicated management API
                const response = await fetch(`${baseURL}/reports/admin/update-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Role': 'admin'
                    },
                    body: JSON.stringify({
                        reportId: reportId,
                        status: newStatus
                    })
                });

                if (response.ok) {
                    alert(`Report ${newStatus === 'APPROVED' ? 'approved' : 'rejected'} successfully!`);
                    loadPendingReports(); // Reload list
                } else {
                    throw new Error('Operation failed, please update manually in Supabase backend');
                }

            } catch (error) {
                // If API doesn't exist, provide manual operation guidance
                const action = newStatus === 'APPROVED' ? 'approve' : 'reject';
                alert(`API operation failed, please manually ${action} report in Supabase backend.\\n\\nSteps:\\n1. Login to Supabase console\\n2. Go to quality_reports table\\n3. Find record with id = ${reportId}\\n4. Change status field to ${newStatus}\\n5. Click save`);
                
                // Still refresh list, user might have operated in backend
                setTimeout(() => loadPendingReports(), 2000);
            }
        }

        // Load reports list when page loads
        window.addEventListener('load', () => {
            loadPendingReports();
        });
    </script>
</body>
</html> 