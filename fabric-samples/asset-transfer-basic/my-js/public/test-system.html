<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统测试 - RiceTrace</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>RiceTrace 系统测试</h1>
        
        <div class="section">
            <h2>服务状态检查</h2>
            <button onclick="checkServices()">检查服务状态</button>
            <div id="serviceStatus"></div>
        </div>

        <div class="section">
            <h2>完整流程测试</h2>
            <p>测试：上传报告 → 创建批次 → 转移批次的完整流程</p>
            <ol>
                <li><a href="upload-report.html">1. 上传质检报告</a></li>
                <li>2. 在 Supabase 后台将报告状态改为 APPROVED</li>
                <li><a href="create.html">3. 创建批次（使用报告ID）</a></li>
                <li><a href="upload-report.html">4. 上传新的质检报告</a></li>
                <li>5. 审核通过新报告</li>
                <li><a href="transfer.html">6. 转移批次（使用新报告ID）</a></li>
                <li><a href="detail.html">7. 查看批次详情</a></li>
            </ol>
        </div>

        <div class="section">
            <h2>API 端点测试</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="testAPI('/reports/status')">报告服务状态</button>
                <button onclick="testAPI('/reports/my')">我的报告列表</button>
                <button onclick="testAPI('/oracle/status')">Oracle 状态</button>
                <button onclick="testAPI('/batch/stats')">批次统计</button>
                <button onclick="testAPI('/batch')">批次列表</button>
                <button onclick="testAPI('/health')">系统健康</button>
            </div>
            <div id="apiTestResult"></div>
        </div>

        <div class="navigation">
            <a href="index.html">返回首页</a>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // 检查服务状态
        async function checkServices() {
            const statusDiv = document.getElementById('serviceStatus');
            showLoading('serviceStatus', '检查服务状态...');

            try {
                // 检查报告服务
                const reportStatus = await apiRequest('GET', '/reports/status', null, 'farmer');
                
                // 检查Oracle服务
                const oracleStatus = await apiRequest('GET', '/oracle/status', null, 'farmer');

                // 检查API健康状态
                const healthStatus = await apiRequest('GET', '/health', null, 'farmer');

                statusDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ 所有服务正常</h3>
                        <h4>报告服务状态：</h4>
                        <ul>
                            <li>R2 存储: ${reportStatus.data.r2.configured ? '✅ 已配置' : '❌ 未配置'}</li>
                            <li>Supabase: ${reportStatus.data.supabase.configured ? '✅ 已配置' : '❌ 未配置'}</li>
                        </ul>
                        <h4>Oracle 服务状态：</h4>
                        <ul>
                            <li>食品安全API: ${oracleStatus.data.foodSafety.configured ? '✅ 已配置' : '❌ 未配置'}</li>
                        </ul>
                        <h4>系统信息：</h4>
                        <ul>
                            <li>版本: ${healthStatus.data.version || '未知'}</li>
                            <li>环境: ${healthStatus.data.environment || '未知'}</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                showError('serviceStatus', `服务检查失败: ${error.message}`);
            }
        }

        // 测试API端点
        async function testAPI(endpoint) {
            const resultDiv = document.getElementById('apiTestResult');
            showLoading('apiTestResult', `测试 ${endpoint}...`);

            try {
                const result = await apiRequest('GET', endpoint, null, 'farmer');
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ ${endpoint} 测试成功</h3>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">
${JSON.stringify(result, null, 2)}
                        </pre>
                    </div>
                `;
            } catch (error) {
                showError('apiTestResult', `${endpoint} 测试失败: ${error.message}`);
            }
        }

        // 页面加载时自动检查服务
        window.addEventListener('load', () => {
            checkServices();
        });
    </script>
</body>
</html> 